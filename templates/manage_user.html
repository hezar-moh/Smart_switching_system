{% extends "base_dashboard.html" %}
{% load static %}

{% block title %}Manage Users - Voice and Web based Home Electronic Devices Switching System{% endblock %}

{% block extra_head %}
  <link rel="stylesheet" href="{% static 'css/manage_user.css' %}">
  {% comment %} <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"> {% endcomment %}
{% endblock %}

{% block content %}
  <h1 class="mb-4">User Management</h1>

  <div class="user-header">
    <button class="btn btn-primary add-user-btn" data-bs-toggle="modal" data-bs-target="#addUserModal">
      + Add User
    </button>
    <div class="search-filter">
      <input type="text" placeholder="Search users..." id="searchUser">
      <select id="filterStatus" class="form-select" style="width: 160px;">
        <option value="all">All Users</option>
        <option value="active">Active Users</option>
        <option value="inactive">Inactive Users</option>
      </select>
    </div>
  </div>

  <div class="table-container">
    <table class="table table-bordered table-hover">
      <thead class="table-light">
        <tr>
          <th>User</th>
          <th>Devices</th>
          <th>Status</th>
          <th>Last Active</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% if users %}
          {% for user in users %}
            <tr data-status="{{ user.is_active|yesno:'active,inactive' }}">
              <td>
                {{ user.get_full_name|default:user.username }}<br>
                <span class="email">{{ user.email }}</span>
              </td>
              <td>{{ user.device_count }}</td>
              <td>
                <form method="POST" action="{% url 'toggle_user_status' user.id %}">
                  {% csrf_token %}
                  <button type="submit" class="status-btn {% if user.is_active %}active-user{% else %}inactive-user{% endif %}">
                    {% if user.is_active %}Active{% else %}Inactive{% endif %}
                  </button>
                </form>
              </td>
              <td>{{ user.last_login|date:"Y-m-d H:i" }}</td>
              <td>
                <form method="POST" action="{% url 'delete_user' user.id %}" onsubmit="return confirm('Delete this user?');">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-sm btn-outline-danger">üóëÔ∏è Delete</button>
                </form>
              </td>
            </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="5" class="text-center">No users found.</td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>

  <!-- Add User Modal -->
  <div class="modal fade" id="addUserModal" tabindex="-1" aria-labelledby="addUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <form method="POST" action="{% url 'add_user' %}">
        {% csrf_token %}
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="addUserModalLabel">Add New User</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            {{ form.as_p }}
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-primary">Create User</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          </div>
        </div>
      </form>
    </div>
  </div>
{% endblock %}

{% block extra_js %}
  <script>
    const searchInput = document.getElementById('searchUser');
    const filterDropdown = document.getElementById('filterStatus');

    function filterUsers() {
      const query = searchInput.value.toLowerCase();
      const statusFilter = filterDropdown.value;
      const rows = document.querySelectorAll('tbody tr');

      rows.forEach(row => {
        const name = row.querySelector('td').textContent.toLowerCase();
        const status = row.getAttribute('data-status');
        const matchesSearch = name.includes(query);
        const matchesStatus = (statusFilter === 'all' || status === statusFilter);

        row.style.display = matchesSearch && matchesStatus ? '' : 'none';
      });
    }

    searchInput.addEventListener('input', filterUsers);
    filterDropdown.addEventListener('change', filterUsers);
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}