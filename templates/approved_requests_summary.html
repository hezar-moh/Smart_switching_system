{% extends 'base_dashboard.html' %}
{% block title %}Approved Device Requests Summary{% endblock %}

{% block content %}
<h1>Approved Device Requests</h1>
{% if messages %}
  <div class="messages">
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }}">{{ message }}</div>
    {% endfor %}
  </div>
{% endif %}

{% if approved_data %}
  <table class="table table-bordered">
    <thead>
      <tr>
        <th>User</th>
        <th>Device Type</th>
        <th>Device Name</th>
        <th>Quantity</th>
        <th>Assigned Pins</th>
        <th>Date of Request</th>
        <th>Date of Approval</th>
        <th>Actions</th> 
      </tr>
    </thead>
    <tbody>
{% for user, requests in approved_data.items %}
  {% with total_devices=0 %}
    {% for req in requests %}
      {% with total_devices=total_devices|add:req.devices|length %}
      {% endwith %}
    {% endfor %}
  {% endwith %}

  {% with shown_user=False %}
    {% for req in requests %}
      {% for device in req.devices %}
        <tr>
          {% if not shown_user %}
            <td rowspan="{{ total_devices }}">{{ user.username }}</td>
            {% with shown_user=True %}
            {% endwith %}
          {% endif %}
          <td>{{ device.device_type.name }}</td>
          <td>{{ device.name }}</td>
          <td>1</td>
          <td>{{ device.pin_number }}</td>
          <td>{{ req.request_date|date:"Y-m-d H:i" }}</td>
          <td>{{ req.approved_date|date:"Y-m-d H:i" }}</td>
          <td>
            <form method="POST" action="{% url 'admin_delete_device' device.id %}" onsubmit="return confirm('Are you sure you want to delete this device?');">
              {% csrf_token %}
              <button type="submit" class="btn btn-danger btn-sm">Delete</button>
            </form>
          </td>
        </tr>
      {% endfor %}
    {% endfor %}
  {% endwith %}
{% endfor %}

    </tbody>
  </table>
{% else %}
  <p>No approved device requests found.</p>
{% endif %}
{% endblock %}
